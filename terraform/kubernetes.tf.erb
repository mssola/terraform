<%#
  # kubernetes setup template
  #
  # some assumptions:
  #
  # * nodes that do not have a reference to a salt master
  #   will be... the salt master.
  # * there will be a grains file for each node, and the
  #   file name will match the hostname.
  #
%>

<% set("cluster_prefix", "k8s") if !exists?("cluster_prefix") %>
<% set("workers_memory", "512") if !exists?("workers_memory") %>

<% if provider == "libvirt" %>
    <% set("domain_type", "libvirt_domain") %>

    provider "libvirt" {
        uri = "<%= libvirt_uri %>"
    }
<% elsif provider == "openstack" %>
    <% set("domain_type", "openstack_compute_instance_v2") %>

    provider "openstack" {
        insecure = "true"
    }
<% end %>

<%= render "inc/network.inc", name: "base" %>
<%= render "inc/volume.inc", name: "base" %>

#####################
# salt master
#####################

<%= render "inc/fip.inc", name: "salt" %>
<%= render "inc/volume.inc", name: "salt", base_id: "base" %>
<%= render "inc/cloudinit_def.inc", name: "salt" %>
<%= render "inc/domain.inc", name: "salt", hostname: "salt-master" %>

<%# we will need to reference this Salt instance later on, but sometimes %>
<%# with the IP address (openstack) and sometimes with the name (libvirt) %>
<% if provider == "openstack" %>
    <% salt_ref = "${openstack_compute_instance_v2.salt.network.0.fixed_ip_v4}" %>
<% elsif provider == "libvirt" %>
    <% if exists?("bridge") %>
        <%# we do not have DNS on bridge mode, so we use a hardcoded IP %>
        <% salt_ref = "${libvirt_domain.salt.network_interface.0.addresses.0}" %>
    <% else %>
        <% salt_ref = "salt-master" %>
    <% end %>
<% end %>

#####################
# etcd
#####################

<%= render "inc/volume.inc", name: "etcd", count: etcd_cluster_size, base_id: "base" %>
<%= render "inc/cloudinit_def.inc", name: "etcd", count: etcd_cluster_size %>
<%= render "inc/domain.inc",
    name: "etcd",
    hostname: "etcd",
    depends_on: ["#{domain_type}.salt" ],
    count: etcd_cluster_size,
    salt_master: salt_ref %>

#####################
# kube-master
#####################

<%= render "inc/fip.inc", name: "master" %>
<%= render "inc/volume.inc", name: "master", base_id: "base" %>
<%= render "inc/cloudinit_def.inc", name: "master" %>
<%= render "inc/domain.inc",
    name: "master",
    hostname: "kube-master",
    flavor_name: "m1.medium",
    depends_on: ["#{domain_type}.salt", "#{domain_type}.etcd" ],
    salt_master: salt_ref %>

#####################
# kube-minion
#####################

<%= render "inc/volume.inc", name: "minion", count: kube_minions_size, base_id: "base" %>
<%= render "inc/cloudinit_def.inc", name: "minion", count: kube_minions_size %>
<%= render "inc/domain.inc",
    name: "minion",
    hostname: "kube-minion",
    depends_on: ["#{domain_type}.salt", "#{domain_type}.master" ],
    count: kube_minions_size,
    salt_master: salt_ref %>
